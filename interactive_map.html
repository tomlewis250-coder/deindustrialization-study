<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map: Manufacturing Decline by County</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #map { width: 100%; height: 100vh; }
        .info {
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 280px;
        }
        .info h4 { margin: 0 0 8px; color: #1a365d; font-size: 14px; }
        .info p { margin: 4px 0; font-size: 12px; color: #4a5568; }
        .info .change { font-size: 18px; font-weight: bold; }
        .info .decline { color: #c53030; }
        .info .growth { color: #276749; }
        .legend {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            line-height: 24px;
        }
        .legend h4 { margin: 0 0 8px; font-size: 13px; color: #1a365d; }
        .legend i { width: 18px; height: 18px; display: inline-block; margin-right: 8px; vertical-align: middle; border-radius: 2px; }
        .legend span { font-size: 12px; color: #4a5568; }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 14px;
        }
        .search-box {
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .search-box input {
            width: 200px;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
        }
        .search-box input:focus {
            outline: none;
            border-color: #1a365d;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Loading map data...</div>
    <div id="map"></div>

    <script>
        // Color scheme
        const colors = {
            severe: '#67000d',
            heavy: '#d73027',
            moderate: '#fc8d59',
            slight: '#fee08b',
            stable: '#91cf60',
            growth: '#1a9850',
            no_data: '#cccccc'
        };

        // Initialize map
        const map = L.map('map').setView([39.5, -98.5], 4);

        // Add tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap, &copy; CARTO',
            maxZoom: 12
        }).addTo(map);

        // Info control
        const info = L.control({position: 'topright'});
        info.onAdd = function() {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        info.update = function(props) {
            if (props) {
                const changeClass = props.change_pct < 0 ? 'decline' : 'growth';
                const changeStr = props.change_pct !== null ?
                    (props.change_pct > 0 ? '+' : '') + props.change_pct.toFixed(1) + '%' : 'N/A';
                this._div.innerHTML = `
                    <h4>${props.name}, ${props.state || ''}</h4>
                    <p class="change ${changeClass}">Mfg Change: ${changeStr}</p>
                    <p><b>Mfg Jobs 2000:</b> ${props.emp_2000 ? props.emp_2000.toLocaleString() : 'N/A'}</p>
                    <p><b>Mfg Jobs 2023:</b> ${props.emp_2023 ? props.emp_2023.toLocaleString() : 'N/A'}</p>
                    <p><b>Poverty Rate:</b> ${props.poverty ? props.poverty + '%' : 'N/A'}</p>
                `;
            } else {
                this._div.innerHTML = '<h4>Hover over a county</h4><p>to see details</p>';
            }
        };
        info.addTo(map);

        // Legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>Mfg Employment Change (2000-2023)</h4>
                <div><i style="background:${colors.growth}"></i><span>> +20% Growth</span></div>
                <div><i style="background:${colors.stable}"></i><span>0 to +20%</span></div>
                <div><i style="background:${colors.slight}"></i><span>0 to -20%</span></div>
                <div><i style="background:${colors.moderate}"></i><span>-20% to -40%</span></div>
                <div><i style="background:${colors.heavy}"></i><span>-40% to -60%</span></div>
                <div><i style="background:${colors.severe}"></i><span>> -60% Severe</span></div>
            `;
            return div;
        };
        legend.addTo(map);

        // Search box
        const searchControl = L.control({position: 'topleft'});
        searchControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'search-box');
            div.innerHTML = '<input type="text" id="search" placeholder="Search county...">';
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        searchControl.addTo(map);

        // Style function
        function style(feature) {
            return {
                fillColor: colors[feature.properties.category] || colors.no_data,
                weight: 0.5,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }

        // Highlight style
        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 2,
                color: '#1a365d',
                fillOpacity: 0.9
            });
            layer.bringToFront();
            info.update(layer.feature.properties);
        }

        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
            info.update();
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight
            });
        }

        // Load GeoJSON
        let geojsonLayer;
        let allFeatures = [];

        fetch('data/counties.geojson')
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';

                geojsonLayer = L.geoJson(data, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);

                // Store features for search
                allFeatures = data.features;

                // Set up search
                const searchInput = document.getElementById('search');
                searchInput.addEventListener('input', function(e) {
                    const query = e.target.value.toLowerCase();
                    if (query.length < 2) return;

                    const matches = allFeatures.filter(f =>
                        f.properties.name && f.properties.name.toLowerCase().includes(query)
                    ).slice(0, 5);

                    if (matches.length === 1) {
                        const bounds = L.geoJson(matches[0]).getBounds();
                        map.fitBounds(bounds, {maxZoom: 8});
                    }
                });
            })
            .catch(err => {
                document.getElementById('loading').textContent = 'Error loading map data';
                console.error(err);
            });
    </script>
</body>
</html>